# LogoCraftAI 用户额度管理脚本使用指南

这些脚本用于管理用户的Logo生成额度，帮助管理员查看、添加和重置用户的使用额度。

## 环境设置

所有脚本都需要访问Redis数据库。首先确保您的项目根目录中有 `.env.local` 或 `.env` 文件，包含以下环境变量：

```
UPSTASH_REDIS_REST_URL=您的Upstash_REST_URL
UPSTASH_REDIS_REST_TOKEN=您的Upstash_REST_TOKEN
```

## 可用脚本

### 1. 查看用户额度

使用此脚本查询用户当前的额度状态：

```bash
node scripts/check-user-credits-fixed.js <用户ID>
```

输出示例：
```
从 .env.local 文件加载配置...
已成功加载环境变量配置
正在查询用户 user_123456 的额度状态...
获取到的当前限流数据: [1646956800000,-10]
用户ID: user_123456
时间窗口开始于: 2022/3/11 0:00:00
剩余额度: 10 次
```

### 2. 添加10次额度

使用此脚本为用户添加10次Logo生成额度：

```bash
node scripts/add-10-credits-from-env-local.js <用户ID>
```

输出示例：
```
从 .env.local 文件加载配置...
已成功加载环境变量配置
正在为用户 user_123456 添加 10 次额度...
获取到的当前限流数据: [1646956800000,-5]
当前状态: 时间窗口开始于 2022/3/11 0:00:00, 使用量: -5
成功为用户 user_123456 添加了 10 次生成额度
当前状态: 剩余额度: 15 次
```

### 3. 添加自定义数量额度

如果需要添加10次以外的额度数量，可以使用此脚本：

```bash
node scripts/add-credits.js <用户ID> <额度数量>
```

例如，添加20次额度：
```bash
node scripts/add-credits.js user_123456 20
```

### 4. 重置用户额度

如果需要完全重置用户的额度限制（删除记录，恢复到默认3次免费额度状态）：

```bash
node scripts/reset-user-limits.js <用户ID>
```

输出示例：
```
从 .env.local 文件加载配置...
已成功加载环境变量配置
正在重置用户 user_123456 的额度限制...
成功重置用户 user_123456 的额度限制
系统将在该用户下次使用Logo生成功能时自动创建新记录，默认拥有3次免费额度
```

## 用户额度机制说明

系统使用Upstash Redis存储用户额度信息，格式为 `[timestamp, usage]`，其中：

- 时间戳（timestamp）：表示记录创建或更新的时间
- 使用量（usage）：
  - 负值表示用户还有预设额度可用，例如 `-10` 表示还有10次额度
  - 正值表示用户已使用的次数，系统默认限制为3次，所以当值为3或更高时，用户将无法继续使用Logo生成功能

## 注意事项

1. 这些脚本需要Node.js环境运行
2. 确保Redis凭证正确配置
3. 用户ID必须是有效的Clerk用户ID
4. 添加额度会将现有额度与新增额度相加
5. 重置用户额度会删除所有限流记录，包括已添加的额外额度 